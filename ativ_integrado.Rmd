---
title: "Atividade Integradora 1 Trimestre"
output: html_document
date: "2023-09-06"
---

```{r setup, include=FALSE}

library(tidyverse)
library(dbplyr)
library(ggplot2)      #Biblioteca para plots gráficos
library(rpart)        #Biblioteca para árvore de regressão
library(rpart.plot)   
library(skimr)        #Biblioteca para overview dos dados
library(rsample)
library(ranger)       #Biblioteca para Random Forest
library(janitor)      #Biblioteca pra remoção de colunas
library(glmnet)       #Biblioteca para modelos de regressão com encolhimento (Ridge, LASSO, elastic-net)
library(plotmo)       #Plotar os gráficos dos coeficientes Ridge

```

# Lendo os dados

```{r}
df <- read.csv("data_2012_numerical.csv")

skim(df)
summary(df)

```

# visualizações iniciais:

```{r}

```

# Vamos considerar os seguintes modelos:

1.  Linear regresion
2.  shrinkage methods
3.  Random Forest
4.  Boosting methods

# Treinamento x Teste

```{r}
set.seed(123)

splits <- initial_split(df, prop = .8)

treinamento <- training(splits)
teste <- testing(splits)
```

# Tabela de comparação dos modelos de predição

```{r}
resultados <- tibble(modelo = c("Linear", "Shrinkage", 
                                "Random Forest", "Boosting"),
                     EQM = NA,
                     R_squared = NA)
```

Obs.: As métricas escolhidas para avaliar o desempenho dos métodos são o Erro quadrático médio (EQM) e o "R quadrado" (R2).

O EQM é uma boa e simples métrica para visualização da média da diferença entre a predição e o valor "alvo".

O R2 é uma métrica mais visual, indicando a linearidade entre os valores predidos e "alvos", variando entre 0 e 1 (com valores mais próximos de 1, sendo melhores, indicando maior relação entre predição e alvo).



Váriáveis identificadas com modelo stepwise para relevância:
```{r}

prediction_vars <- c('balsheet_notfullyear', 'labor_avg', 'birth_year', 'personnel_exp', 'inventories', 'inoffice_days', 'log_sales', 'curr_liab')

formula <- paste("fechado ~", paste(prediction_vars, collapse = " + "))
```

# modelos:

## Modelo 1

Regressão Linear

```{r}
resultados_linear <- tibble(modelo = c("All_var", "Stepwise_var"),
                            EQM = NA,
                            R_squared = NA)
```

Primeira iteração:
Todas as variáveis menos comp_id

```{r}
# Fit
fit_lm <- lm(fechado ~ .-comp_id, data = treinamento)

# Predição
depend_predict_lm <- predict(fit_lm, newdata = teste)

# Calculo EQM
EQM <- mean((teste$fechado - depend_predict_lm)^2)

# Calculo R quadrado
r2 <- summary(fit_lm)$r.squared

# Salvando resultados:
resultados_linear$EQM[resultados_linear$modelo == "All_var"] <- EQM
resultados_linear$R_squared[resultados_linear$modelo == "All_var"] <- r2
```
```{r}
# Fit
fit_lm <- lm(formula, data = treinamento)

# Predição
depend_predict_lm <- predict(fit_lm, newdata = teste)

# Calculo EQM
EQM <- mean((teste$fechado - depend_predict_lm)^2)

# Calculo R quadrado
r2 <- summary(fit_lm)$r.squared

# Salvando resultados:
resultados_linear$EQM[resultados_linear$modelo == "Stepwise_var"] <- EQM
resultados_linear$R_squared[resultados_linear$modelo == "Stepwise_var"] <- r2
```


Melhores resultados do modelo Linear:
```{r}
resultados$EQM[resultados$modelo == "Linear"] <- max(resultados_linear$EQM)
resultados$EQM[resultados$modelo == "Linear"] <- max(resultados_linear$R_squared)
```


## Modelo 2

Encolhimento - LASSO

```{r}
# Preparando para glmnet ------------------------------

#str(treinamento)

#desconsiderando variável dependente:

x <- as.matrix(treinamento[, -which(names(treinamento)=="fechado")]) 
y <- treinamento$fechado

x_test <- as.matrix(teste[, -which(names(treinamento)=="fechado")])
y_test <- teste$fechado

#definindo sequência de lambda
lambda_seq <- 10^seq(10, -2, length=100)
```

```{r}
# Fit
fit_lasso <- glmnet(x, y, alpha = 1)

#plot_glmnet(fit_lasso)

# Cross-Validation
cv_lasso <- cv.glmnet(x, y, alpha = 1)

# Escolhendo melhor valor de lambda com a cross validadtion
lambda_lasso <- cv_lasso$lambda.1se #melhor valor de lambda (no caso 1 desv. pad. do min)



# Predição
depend_predict_lasso <- predict(fit_lasso,
                                newx = x_test,
                                s = lambda_lasso)

# Calculo EQM
EQM_lasso <- mean((y_test - depend_predict_lasso)^2)

# Calculo R quadrado
r2 <- 1 - (EQM_lasso/var(y_test))

# Salvando resultados:
resultados$EQM[resultados$modelo == "Shrinkage"] <- EQM_lasso
resultados$R_squared[resultados$modelo == "Shrinkage"] <- r2
```

## Modelo 3

Random Forest

```{r}
# Fit


# Predição


# Calculo EQM
EQM <- 

# Calculo R quadrado
r2 <- 

# Salvando resultados:
resultados$EQM[resultados$modelo == "modelo"] <- EQM
resultados$R_squared[resultados$modelo == "modelo"] <- r2
```

## Modelo 4

Boosting

```{r}
# Fit


# Predição


# Calculo EQM
EQM <- 

# Calculo R quadrado
r2 <- 

# Salvando resultados:
resultados$EQM[resultados$modelo == "modelo"] <- EQM
resultados$R_squared[resultados$modelo == "modelo"] <- r2
```
